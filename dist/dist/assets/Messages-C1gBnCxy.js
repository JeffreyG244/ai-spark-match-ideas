import{j as e}from"./vendor-ui-BOBT-NyQ.js";import{r as h}from"./vendor-LxWyOK1e.js";import{u as F,s as l,t as m,B as C,P as z,V as U,b as A,c as D,d as B,e as k,m as H}from"./index-DNN11rcK.js";import{I as L}from"./input-B8vtTylD.js";import{M as E}from"./message-circle-BsyyCNNb.js";import{P}from"./plus-C4ZkGiFv.js";import{S as V}from"./search-ns0dn5CY.js";import{U as T}from"./user-BmdG_I6i.js";import{C as Y}from"./coffee-D4ikyqW_.js";import{S as G,E as O}from"./smile-CP3wxTuN.js";import{S as W}from"./send-PUKPZ8gq.js";import{T as I}from"./trash-2-CP18VoS0.js";import{L as X}from"./logo-CkB_3k13.js";import{u as K}from"./vendor-router-hC09K-xx.js";import{A as J}from"./arrow-left-dGaAc19p.js";import"./vendor-supabase-DciMRLNE.js";import"./vendor-query-BXVzPZ54.js";const Q=()=>{const{user:s}=F(),[t,u]=h.useState([]),[i,p]=h.useState(!0),n=h.useRef(null),_=h.useRef(!1),w=async()=>{if(s)try{const{data:d,error:x}=await l.from("conversations").select("*").or(`participant_1.eq.${s.id},participant_2.eq.${s.id}`).order("updated_at",{ascending:!1});if(x)throw x;const v=d?.map(b=>({...b,other_participant:b.participant_1===s.id?b.participant_2:b.participant_1,updated_at:b.last_message_at||b.created_at}))||[];u(v)}catch{}finally{p(!1)}},f=async d=>{if(!s)return null;try{const{data:x}=await l.from("conversations").select("*").or(`and(participant_1.eq.${s.id},participant_2.eq.${d}),and(participant_1.eq.${d},participant_2.eq.${s.id})`).single();if(x)return x;const{data:v,error:b}=await l.from("conversations").insert({participant_1:s.id,participant_2:d}).select().single();if(b)throw b;return v}catch{return null}};return h.useEffect(()=>{if(!s){p(!1);return}if(w(),!_.current)try{n.current&&(l.removeChannel(n.current),n.current=null);const d=`conversations-${s.id}-${Date.now()}`;n.current=l.channel(d).on("postgres_changes",{event:"*",schema:"public",table:"conversations"},x=>{w()}).subscribe((x,v)=>{v||x==="SUBSCRIBED"&&(_.current=!0)})}catch{}return()=>{if(n.current&&_.current)try{l.removeChannel(n.current),n.current=null,_.current=!1}catch{}}},[s?.id]),{conversations:t,isLoading:i,createOrGetConversation:f,loadConversations:w}},Z=s=>{let t=document.createElement("p");return t.appendChild(document.createTextNode(s)),t.innerHTML},ee=s=>{let t=document.createElement("div");return t.innerHTML=s,t.textContent||t.innerText||""},se=s=>{const t=/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F1E6}-\u{1F1FF}]/gu;return s.replace(t,"")},te=(s,t)=>{let u=!0;const i=[];return s||(u=!1,i.push("Content cannot be empty.")),s.length>t&&(u=!1,i.push(`Content exceeds the maximum length of ${t} characters.`)),Z(s)!==s&&(u=!1,i.push("Content contains HTML or script tags.")),ee(s)!==s&&(u=!1,i.push("Content contains disallowed HTML.")),se(s)!==s&&(u=!1,i.push("Content contains emojis.")),["badword1","badword2","inappropriateword"].some(f=>s.toLowerCase().includes(f))&&(u=!1,i.push("Content contains inappropriate language.")),{isValid:u,errors:i}},re=s=>!s||typeof s!="string"?"":s.trim().replace(/[<>]/g,""),ae=s=>te(s,ne.MESSAGE_MAX_LENGTH),ie=async s=>re(s),g=(s,t,u="low")=>{},ne={MESSAGE_MAX_LENGTH:1e3},oe=s=>{const{user:t}=F(),[u,i]=h.useState([]),[p,n]=h.useState(!0),[_,w]=h.useState(!1),f=h.useRef(null),d=h.useRef(!1),x=h.useRef(null),v=h.useRef(0),b=async()=>{if(!s||!t){i([]),n(!1);return}try{const{data:o,error:a}=await l.from("conversations").select("*").or(`participant_1.eq.${t.id},participant_2.eq.${t.id}`).eq("id",s).single();if(a||!o){g("unauthorized_conversation_access",`User ${t.id} attempted to access unauthorized conversation ${s}`,"high"),m({title:"Access denied",description:"You don't have permission to view this conversation",variant:"destructive"}),i([]),n(!1);return}const{data:r,error:c}=await l.from("conversation_messages").select("*").eq("conversation_id",s).is("deleted_at",null).order("created_at",{ascending:!0});if(c)throw c;r&&v.current>0&&r.length>v.current+5&&g("message_injection_suspected",`Abnormal message count increase in conversation ${s}`,"high"),v.current=r?.length||0,i(r||[])}catch{}finally{n(!1)}},y=async()=>{if(!t)return!1;`${t.id}`;try{const{data:o,error:a}=await l.rpc("secure_rate_limit_check",{user_id_param:t.id,action_type:"send_message",max_requests:10,window_minutes:1});return a?!1:!!o}catch{return!1}},$=async o=>{if(!(!t||!s||!o.trim())){`${t.id}`,w(!0);try{const{data:a,error:r}=await l.from("conversations").select("*").or(`participant_1.eq.${t.id},participant_2.eq.${t.id}`).eq("id",s).single();if(r||!a){g("unauthorized_message_send",`User ${t.id} attempted to send message to unauthorized conversation ${s}`,"high"),m({title:"Access denied",description:"You don't have permission to send messages in this conversation",variant:"destructive"});return}const c=await ie(o.trim()),j=await ae(c);if(!j.isValid){m({title:"Invalid message",description:j.errors.join(", "),variant:"destructive"}),g("invalid_message_content",`User ${t.id}: ${j.errors.join(", ")}`,"medium");return}if(!await y()){m({title:"Rate limit exceeded",description:"You are sending messages too quickly. Please wait a moment.",variant:"destructive"}),g("server_rate_limit_exceeded",`User ${t.id} exceeded server rate limit`,"high");return}const{error:M}=await l.from("conversation_messages").insert({conversation_id:s,sender_id:t.id,content:c,message_type:"text"});M&&(g("message_send_error",`User ${t.id}: ${M.message}`,"high"),m({title:"Failed to send message",description:"Please try again later.",variant:"destructive"}))}catch(a){g("message_send_exception",`User ${t.id}: ${a}`,"high"),m({title:"Failed to send message",description:"An unexpected error occurred.",variant:"destructive"})}finally{w(!1)}}},S=async o=>{if(t)try{const{data:a,error:r}=await l.from("conversation_messages").select("conversation_id, sender_id").eq("id",o).single();if(r||!a)return;const{data:c,error:j}=await l.from("conversations").select("*").or(`participant_1.eq.${t.id},participant_2.eq.${t.id}`).eq("id",a.conversation_id).single();if(j||!c||a.sender_id===t.id)return;const{error:N}=await l.from("conversation_messages").update({read_at:new Date().toISOString()}).eq("id",o);if(N)throw N}catch(a){g("mark_read_error",`User ${t.id}: ${a}`,"low")}};return h.useEffect(()=>{if(x.current!==s){if(f.current&&d.current)try{l.removeChannel(f.current),f.current=null,d.current=!1}catch{}x.current=s,v.current=0}if(!s||!t){i([]),n(!1);return}if(b(),!d.current)try{const o=`messages-${s}-${Date.now()}`;f.current=l.channel(o).on("postgres_changes",{event:"INSERT",schema:"public",table:"conversation_messages",filter:`conversation_id=eq.${s}`},a=>{if(!a.new||typeof a.new!="object"||!a.new.id){g("invalid_message_received",`Invalid message structure received in conversation ${s}`,"medium");return}a.new.conversation_id===s&&(i(r=>[...r,a.new]),v.current+=1)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"conversation_messages",filter:`conversation_id=eq.${s}`},a=>{if(!a.new||typeof a.new!="object"||!a.new.id){g("invalid_message_update",`Invalid message update received in conversation ${s}`,"medium");return}i(r=>r.map(c=>c.id===a.new.id?a.new:c))}).subscribe((a,r)=>{r?g("realtime_subscription_error",`Messages: ${r.message}`,"medium"):a==="SUBSCRIBED"&&(d.current=!0)})}catch{}return()=>{if(f.current&&d.current)try{l.removeChannel(f.current),f.current=null,d.current=!1}catch{}}},[s,t]),{messages:u,isLoading:p,isSending:_,sendMessage:$,markAsRead:S,deleteMessage:async o=>{if(!t)return!1;try{const{data:a,error:r}=await l.from("conversation_messages").select("sender_id, conversation_id").eq("id",o).single();if(r||!a)return m({title:"Error",description:"Message not found",variant:"destructive"}),!1;if(a.sender_id!==t.id)return g("unauthorized_message_delete",`User ${t.id} attempted to delete message ${o} owned by ${a.sender_id}`,"high"),m({title:"Access denied",description:"You can only delete your own messages",variant:"destructive"}),!1;const{data:c,error:j}=await l.from("conversations").select("*").or(`participant_1.eq.${t.id},participant_2.eq.${t.id}`).eq("id",a.conversation_id).single();if(j||!c)return g("unauthorized_conversation_message_delete",`User ${t.id} attempted to delete message from unauthorized conversation`,"high"),m({title:"Access denied",description:"You cannot delete messages from this conversation",variant:"destructive"}),!1;const{error:N}=await l.from("conversation_messages").update({deleted_at:new Date().toISOString(),content:"[Message deleted]"}).eq("id",o);return N?(m({title:"Delete failed",description:"Unable to delete message. Please try again.",variant:"destructive"}),!1):(i(M=>M.filter(R=>R.id!==o)),m({title:"Message deleted",description:"Message has been permanently deleted"}),!0)}catch(a){return g("message_delete_error",`User ${t.id}: ${a}`,"medium"),m({title:"Delete failed",description:"An unexpected error occurred",variant:"destructive"}),!1}}}},ce=({recipientId:s,recipientName:t})=>{const u=async()=>{try{const p=await navigator.mediaDevices.getUserMedia({audio:!0});m({title:"Audio Call Started",description:`Calling ${t}... (Demo mode - calling system active)`,duration:3e3}),p.getTracks().forEach(n=>n.stop())}catch{m({title:"Microphone Permission Denied",description:"Please allow microphone access to make calls",variant:"destructive"})}},i=async()=>{try{const p=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});m({title:"Video Call Started",description:`Video calling ${t}... (Demo mode - calling system active)`,duration:3e3}),p.getTracks().forEach(n=>n.stop())}catch{m({title:"Camera/Microphone Permission Denied",description:"Please allow camera and microphone access to make video calls",variant:"destructive"})}};return e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"outline",size:"sm",onClick:u,className:"bg-slate-700/50 border-slate-600/30 text-white hover:bg-slate-600/50",children:e.jsx(z,{className:"w-4 h-4"})}),e.jsx(C,{variant:"outline",size:"sm",onClick:i,className:"bg-slate-700/50 border-slate-600/30 text-white hover:bg-slate-600/50",children:e.jsx(U,{className:"w-4 h-4"})})]})},le=()=>{const{user:s}=F(),[t,u]=h.useState(null),[i,p]=h.useState(""),{conversations:n,isLoading:_}=Q(),{messages:w,isLoading:f,isSending:d,sendMessage:x,deleteMessage:v}=oe(t),b=_||f,y=t?n.find(r=>r.id===t):null,$=()=>!y||!s?.id?null:{id:y.participant_1===s.id?y.participant_2:y.participant_1,name:"Professional Connection"};h.useEffect(()=>{n.length>0&&!t&&u(n[0].id)},[n,t]);const S=async()=>{if(!(!i.trim()||!t))try{await x(i.trim()),p(""),m({title:"Message Sent",description:"Your message has been sent successfully"})}catch{m({title:"Send Failed",description:"Failed to send message. Please try again.",variant:"destructive"})}},q=async r=>{try{const c=await v(r)}catch{}},o=({conversation:r})=>e.jsx("div",{className:`p-4 cursor-pointer transition-all border-l-4 ${t===r.id?"bg-purple-500/5 border-purple-500":"hover:bg-gray-100/5 border-transparent"}`,onClick:()=>{u(r.id)},children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center",children:e.jsx(T,{className:"w-6 h-6 text-white"})}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-white truncate",children:"Professional Connection"}),e.jsx("p",{className:"text-sm text-gray-300 truncate",children:"Executive â€¢ Active now"}),e.jsx("span",{className:"text-xs text-gray-400",children:new Date(r.created_at).toLocaleDateString()})]})]})}),a=({message:r})=>{const c=r.sender_id===s?.id,[j,N]=h.useState(!1);return e.jsx("div",{className:`flex ${c?"justify-end":"justify-start"} mb-4 group`,children:e.jsxs("div",{className:`relative max-w-xs lg:max-w-md ${c?"bg-gradient-to-r from-purple-600 to-pink-600 text-white":"bg-gray-700 text-white"} rounded-2xl px-4 py-2 shadow-sm`,children:[e.jsx("p",{className:"text-sm leading-relaxed",children:r.content}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("span",{className:"text-xs opacity-70",children:new Date(r.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),c&&e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx(H,{className:"w-3 h-3 opacity-70"})})]}),c&&e.jsx("div",{className:"absolute -right-2 -top-2",children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>N(!j),className:"opacity-0 group-hover:opacity-100 transition-opacity bg-slate-700/90 hover:bg-slate-600/90 rounded-full p-1 shadow-lg",children:e.jsx(O,{className:"w-3 h-3 text-white"})}),j&&e.jsx("div",{className:"absolute top-8 right-0 bg-slate-800/95 backdrop-blur-xl border border-gray-600/30 rounded-lg p-1 shadow-2xl z-50 min-w-[120px]",children:e.jsxs("button",{onClick:()=>{window.confirm("Are you sure you want to delete this message? This action cannot be undone.")&&q(r.id),N(!1)},className:"w-full flex items-center space-x-2 px-3 py-2 hover:bg-slate-700/50 rounded-lg transition-all text-red-400 text-sm",children:[e.jsx(I,{className:"w-3 h-3"}),e.jsx("span",{children:"Delete"})]})})]})})]})})};return b?e.jsx("div",{className:"h-96 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-purple-300",children:"Loading executive conversations..."})]})}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]",children:[e.jsxs(A,{className:"lg:col-span-1 bg-gradient-to-br from-slate-800/60 to-slate-700/60 backdrop-blur-xl border border-gray-600/30",children:[e.jsxs(D,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(B,{className:"flex items-center space-x-2 text-white",children:[e.jsx(E,{className:"w-5 h-5 text-purple-400"}),e.jsx("span",{children:"Messages"})]}),e.jsx(C,{variant:"outline",size:"sm",className:"bg-slate-700/50 border-slate-600/30 text-white hover:bg-slate-600/50",children:e.jsx(P,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(V,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(L,{placeholder:"Search conversations...",className:"pl-10 bg-slate-700/50 border-slate-600/30 text-white placeholder-gray-400"})]})]}),e.jsx(k,{className:"p-0",children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:n.length===0?e.jsxs("div",{className:"text-center py-8 px-4",children:[e.jsx(E,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"font-semibold text-white mb-2",children:"No Conversations"}),e.jsx("p",{className:"text-sm text-gray-300",children:"Start discovering to begin executive conversations"})]}):n.map(r=>e.jsx(o,{conversation:r},r.id))})})]}),e.jsx(A,{className:"lg:col-span-2 bg-gradient-to-br from-slate-800/60 to-slate-700/60 backdrop-blur-xl border border-gray-600/30",children:y?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"pb-3 border-b border-gray-600/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center",children:e.jsx(T,{className:"w-5 h-5 text-white"})}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-emerald-500 border border-white rounded-full"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:"Professional Connection"}),e.jsx("p",{className:"text-sm text-gray-300",children:"Active now"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[$()&&e.jsx(ce,{recipientId:$().id,recipientName:$().name}),e.jsx(C,{variant:"outline",size:"sm",className:"bg-slate-700/50 border-slate-600/30 text-white hover:bg-slate-600/50",children:e.jsx(Y,{className:"w-4 h-4"})})]})]})}),e.jsxs(k,{className:"flex-1 p-4",children:[e.jsx("div",{className:"h-80 overflow-y-auto mb-4 space-y-2",children:w.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-300",children:"No messages yet. Start the conversation!"})]}):w.map(r=>e.jsx(a,{message:r},r.id))}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(C,{variant:"outline",size:"sm",className:"bg-slate-700/50 border-slate-600/30 text-white hover:bg-slate-600/50",children:e.jsx(G,{className:"w-4 h-4"})}),e.jsx(L,{placeholder:"Type your professional message...",value:i,onChange:r=>p(r.target.value),onKeyPress:r=>r.key==="Enter"&&S(),className:"flex-1 bg-slate-700/50 border-slate-600/30 text-white placeholder-gray-400"}),e.jsx(C,{onClick:S,disabled:!i.trim()||d,className:"bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white disabled:opacity-50",children:e.jsx(W,{className:"w-4 h-4"})})]})]})]}):e.jsx(k,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(E,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-300",children:"Choose a match to start your professional conversation"})]})})})]})},Se=()=>{const s=K();return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex flex-col",children:[e.jsx("header",{className:"bg-black/20 backdrop-blur-xl border-b border-purple-500/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:()=>s("/dashboard"),className:"bg-slate-800/50 backdrop-blur-xl border border-slate-600/30 rounded-xl p-3 hover:bg-slate-700/50 transition-all",children:e.jsx(J,{className:"w-5 h-5 text-white"})}),e.jsx(X,{size:"lg",showText:!1}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Messages"}),e.jsx("p",{className:"text-purple-300 text-sm",children:"Your conversations & connections"})]})]}),e.jsx("div",{className:"flex items-center space-x-4",children:e.jsxs("button",{className:"bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl font-semibold hover:scale-105 transition-all",children:[e.jsx(P,{className:"w-5 h-5 inline mr-2"}),"New Message"]})})]})})}),e.jsx("main",{className:"flex-1 p-6",children:e.jsx("div",{className:"bg-gradient-to-br from-slate-800/60 to-slate-700/60 backdrop-blur-xl border border-gray-600/30 rounded-2xl p-6",children:e.jsx(le,{})})})]})};export{Se as default};
